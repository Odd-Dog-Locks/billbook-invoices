<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Locksmith Bill Book</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Bill Book">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%1e40af'/><text y='60' font-size='50' text-anchor='middle' x='50' fill='white'>Bill</text></svg>">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:;">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
    @media print {
        @page { margin: 8mm; size: A4 portrait; }
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background: white; }
        #controls, #signatureModal, #historyView, #tabBill, #tabHistory, .no-print { display: none !important; }
        #billView, #bill { display: block !important; box-shadow: none !important; border-radius: 0 !important; width: 210mm !important; min-height: 297mm !important; margin: 0 !important; }
        .preserve { white-space: pre-line !important; display: block !important; border: 1px solid #d1d5db !important; border-radius: 0.375rem !important; padding: 0.5rem !important; font-size: 0.875rem !important; margin-top: 0.25rem !important; }
        textarea { display: none !important; }
        h1 { font-size: 22pt !important; }
    }
    .preserve { white-space: pre-line; display: none; }
    #signatureCanvas { touch-action: none; }
</style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- [Full HTML same as before – keeping it short for clarity] -->
<div id="app" class="max-w-4xl mx-auto p-4">
    <!-- ... all your existing HTML ... -->
    <!-- (Header, tabs, controls, bill, signature box, etc. – unchanged) -->

    <div class="border-t-2 pt-4">
        <strong>Customer Signature:</strong>
        <div class="mt-2 border-2 border-dashed border-gray-500 rounded bg-gray-50" style="height:160px; position:relative;">
            <img id="signaturePreview" src="" class="max-w-full max-h-full object-contain mx-auto block absolute inset-0 m-auto" style="display:none;">
        </div>
        <div class="mt-3 flex gap-3 no-print">
            <button class="add-sig-btn bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded">Add Signature</button>
            <button class="clear-sig-btn bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded">Clear</button>
        </div>
    </div>
    <!-- ... rest of bill ... -->
</div>

<!-- Signature Modal -->
<div id="signatureModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 p-4 no-print">
    <div class="bg-white rounded-2xl shadow-3xl w-full max-w-2xl p-6">
        <h3 class="text-2xl font-bold text-center mb-4">Sign Here</h3>
        <canvas id="signatureCanvas" class="border-4 border-gray-800 rounded-xl bg-white w-full" height="400"></canvas>
        <div class="mt-6 flex justify-center gap-4">
            <button class="clear-modal-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded">Clear</button>
            <button class="cancel-modal-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded">Cancel</button>
            <button class="done-modal-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded">Done</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... all previous working code (history, billing, etc.) unchanged ...

    // === SIGNATURE FIX FOR SAFARI / PWA ===
    const modal = document.getElementById('signatureModal');
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    const preview = document.getElementById('signaturePreview');
    let drawing = false;

    function resizeCanvas() {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function openSignatureModal() {
        modal.classList.remove('hidden');
        clearModalSignature();
        resizeCanvas();
    }
    function closeSignatureModal() { modal.classList.add('hidden'); }
    function clearModalSignature() { ctx.clearRect(0,0,canvas.width,canvas.height); }

    // THE FIX: Use onload to force Safari to accept the data URL
    function saveSignature() {
        const dataUrl = canvas.toDataURL('image/png');
        preview.style.display = 'none'; // hide first
        preview.src = '';               // clear src
        preview.onload = () => {
            preview.style.display = 'block';
        };
        preview.onerror = () => {
            // Fallback: create a blob URL (works even when data: is blocked)
            canvas.toBlob(blob => {
                preview.src = URL.createObjectURL(blob);
                preview.style.display = 'block';
            });
        };
        preview.src = dataUrl; // trigger onload/onerror
        closeSignatureModal();
    }

    function clearSignature() {
        preview.src = '';
        preview.style.display = 'none';
    }

    // Button bindings
    document.querySelector('.add-sig-btn').onclick = openSignatureModal;
    document.querySelector('.clear-sig-btn').onclick = clearSignature;
    document.querySelector('.clear-modal-btn').onclick = clearModalSignature;
    document.querySelector('.cancel-modal-btn').onclick = closeSignatureModal;
    document.querySelector('.done-modal-btn').onclick = saveSignature;

    // Drawing events
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        return {x, y};
    }
    canvas.addEventListener('mousedown', e => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('touchstart', e => { e.preventDefault(); drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('mousemove', e => { if (drawing) { const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.strokeStyle = '#000'; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.stroke(); }});
    canvas.addEventListener('touchmove', e => { e.preventDefault(); if (drawing) { const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.strokeStyle = '#000'; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.stroke(); }});
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('touchend', () => drawing = false);

    // ... rest of your working code (print, PDF, new bill, etc.) ...
});
</script>
</body>
</html>
