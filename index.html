<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Locksmith Bill Book</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Bill Book">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%1e40af'/><text y='60' font-size='50' text-anchor='middle' x='50' fill='white'>Bill</text></svg>">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:;">
<script src="https://cdn.tailwindcss.com" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
<style>
    @media print {
        @page { margin: 8mm; size: A4 portrait; }
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background: white; }
        #controls, #modeToggleContainer, #signatureModal, #historyView, #tabBill, #tabHistory, .no-print { display: none !important; }
        #billView, #bill { display: block !important; box-shadow: none !important; border-radius: 0 !important; width: 210mm !important; min-height: 297mm !important; margin: 0 !important; }
        .preserve { white-space: pre-line !important; display: block !important; border: 1px solid #d1d5db !important; border-radius: 0.375rem !important; padding: 0.5rem !important; font-size: 0.875rem !important; margin-top: 0.25rem !important; }
        textarea { display: none !important; }
        h1 { font-size: 22pt !important; }
    }
    .preserve { white-space: pre-line; display: none; }
    #signatureCanvas { touch-action: none; }
</style>
</head>
<body class="bg-gray-100 min-h-screen">

<div id="app" class="max-w-4xl mx-auto p-4">

    <div class="flex border-b mb-6">
        <button id="tabBill" class="px-6 py-3 font-bold text-blue-600 border-b-4 border-blue-600">New Bill</button>
        <button id="tabHistory" class="px-6 py-3 font-bold text-gray-600">History (<span id="historyCount">0</span>)</button>
    </div>

    <div id="billView">
        <div id="controls" class="mb-5 flex flex-wrap items-center justify-between gap-4 no-print">
            <div class="flex gap-3">
                <button id="printBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-lg shadow">Print</button>
                <button id="pdfBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-6 rounded-lg shadow">Save PDF</button>
                <button id="newBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2.5 px-5 rounded-lg shadow">New</button>
            </div>
            <div id="modeToggleContainer" class="flex items-center gap-3 bg-gray-200 rounded-full p-1.5">
                <span class="px-4 text-sm font-medium text-gray-600">NSP</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="modeToggle" class="sr-only peer" checked>
                    <div class="w-14 h-8 bg-gray-400 rounded-full peer-checked:bg-blue-600 transition"></div>
                    <div class="absolute left-1 top-1 w-6 h-6 bg-white rounded-full transition peer-checked:translate-x-6"></div>
                </label>
                <span class="px-4 text-sm font-bold text-gray-700">BILL</span>
            </div>
        </div>

        <div id="bill" class="bg-white rounded-xl overflow-hidden shadow-xl">
            <div class="bg-gradient-to-r from-blue-800 to-blue-900 text-white p-5 text-center">
                <h1 contenteditable="true" class="text-3xl font-bold outline-none leading-none">Your Business Name</h1>
                <p contenteditable="true" class="text-sm mt-2 outline-none">123 Main Street • City • State</p>
                <p contenteditable="true" class="text-lg mt-1 outline-none">+91 98765 43210</p>
            </div>
            <div class="p-5 space-y-4 text-base">
                <div class="grid grid-cols-2 gap-6">
                    <div><strong>Invoice No:</strong> <span id="invoiceNo" class="ml-3 bg-gray-200 px-4 py-1 rounded font-mono font-bold text-blue-800">251130-001</span></div>
                    <div><strong>Date:</strong> <input type="date" id="billDate" class="ml-3 border-b-2 border-gray-500 w-36" readonly></div>
                </div>
                <div>
                    <strong>Customer Name & Address:</strong><br>
                    <textarea rows="2" id="customer" class="w-full mt-1 border border-gray-300 rounded p-2 text-sm resize-none focus:border-blue-600 outline-none"></textarea>
                    <div id="customerPrint" class="preserve mt-1 text-sm"></div>
                </div>
                <div>
                    <strong>Description of Work Performed:</strong><br>
                    <textarea rows="6" id="description" class="w-full mt-1 border border-gray-300 rounded p-2 text-sm resize-none focus:border-blue-600 outline-none"></textarea>
                    <div id="descriptionPrint" class="preserve mt-1 text-sm"></div>
                </div>
                <div id="billingSection" class="border-t-2 border-dashed pt-3 text-sm">
                    <div class="flex justify-between items-center mb-1">
                        <strong>Itemized Charges</strong>
                        <div class="text-xs">Tax: <input type="number" id="taxRate" value="8" min="0" max="30" step="0.1" class="w-14 text-right border rounded px-1 py-0.5">%</div>
                    </div>
                    <table class="w-full mt-2">
                        <tbody id="itemsTable" class="text-xs"></tbody>
                        <tfoot class="border-t border-gray-700">
                            <tr><td colspan="2" class="text-right font-bold py-1">Subtotal:</td><td class="text-right font-bold" id="subtotal">$0.00</td></tr>
                            <tr><td colspan="2" class="text-right py-1">Tax (<span id="taxPercent">8.0</span>%):</td><td class="text-right" id="taxAmount">$0.00</td></tr>
                            <tr class="border-t-2 border-double border-gray-800">
                                <td colspan="2" class="text-right font-bold text-base py-2">TOTAL DUE:</td>
                                <td class="text-right font-bold text-xl text-blue-700" id="totalDue">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="my-3 text-xs text-gray-700 text-center italic leading-tight border-t border-b py-2">
                    By signing below, you confirm you are authorized to approve the work and accept all charges. You acknowledge the work was completed to your satisfaction and waive any claims arising from this service.
                </div>
                <div class="border-t-2 pt-4">
                    <strong>Customer Signature:</strong>
                    <div class="mt-2 border-2 border-dashed border-gray-500 rounded bg-gray-50" style="height:140px;">
                        <img id="signaturePreview" src="" class="max-w-full max-h-full object-contain mx-auto block" style="display:none; margin-top:12px;">
                    </div>
                    <div class="mt-3 flex gap-3 no-print">
                        <button id="addSigBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded">Add Signature</button>
                        <button id="clearSigBtn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded">Clear</button>
                    </div>
                </div>
                <div class="text-center text-xs text-gray-600 pt-3 border-t">
                    <p contenteditable="true" class="outline-none">Payment due on receipt • Thank you!</p>
                </div>
            </div>
        </div>
    </div>

    <div id="historyView" class="hidden">
        <div class="mb-4">
            <input type="text" id="searchHistory" placeholder="Search customer, invoice, amount..." class="w-full p-3 border rounded-lg text-lg">
        </div>
        <div id="historyList" class="space-y-3"></div>
    </div>
</div>

<div id="signatureModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 p-4 no-print">
    <div class="bg-white rounded-2xl shadow-3xl w-full max-w-2xl p-6">
        <h3 class="text-2xl font-bold text-center mb-4">Sign Here</h3>
        <canvas id="signatureCanvas" class="border-4 border-gray-800 rounded-xl bg-white w-full" height="400"></canvas>
        <div class="mt-6 flex justify-center gap-4">
            <button id="clearModalBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded">Clear</button>
            <button id="cancelModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded">Cancel</button>
            <button id="doneModalBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded">Done</button>
        </div>
    </div>
</div>

<script>
// DOM READY - SAFE LOAD
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - starting app init');
    
    // History with localStorage (no crashes)
    let historyData = JSON.parse(localStorage.getItem('billbook_history') || '[]');
    function saveHistory() { localStorage.setItem('billbook_history', JSON.stringify(historyData)); }
    function updateHistoryCount() { document.getElementById('historyCount').textContent = historyData.length; }
    function addToHistory(bill) { historyData.unshift(bill); if (historyData.length > 100) historyData.pop(); saveHistory(); updateHistoryCount(); }
    function loadHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = historyData.map((b, i) => `
            <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                <div>
                    <strong class="text-lg">${b.invoiceNo}</strong> • ${b.date}
                    <div class="text-gray-600">${b.customer.split('\n')[0] || 'No customer'}</div>
                    <div class="font-bold text-blue-600">${b.total}</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="viewBill(${i})" class="bg-blue-600 text-white px-4 py-2 rounded">View</button>
                    <button onclick="deleteBill(${i})" class="bg-red-600 text-white px-4 py-2 rounded">Delete</button>
                </div>
            </div>
        `).join('');
    }
    window.viewBill = function(i) {
        const b = historyData[i];
        document.getElementById('bill').innerHTML = b.html;
        document.getElementById('controls').innerHTML = `<div class="text-center my-10"><button onclick="location.reload()" class="bg-gray-600 text-white px-8 py-4 rounded-lg text-lg">Back to New Bill</button></div>`;
    };
    window.deleteBill = function(i) {
        if (confirm('Delete this bill permanently?')) {
            historyData.splice(i, 1);
            saveHistory();
            loadHistory();
        }
    };

    // Tabs
    document.getElementById('tabBill').onclick = () => {
        document.getElementById('billView').classList.remove('hidden');
        document.getElementById('historyView').classList.add('hidden');
    };
    document.getElementById('tabHistory').onclick = () => {
        document.getElementById('billView').classList.add('hidden');
        document.getElementById('historyView').classList.remove('hidden');
        loadHistory();
    };

    // Search
    document.getElementById('searchHistory').addEventListener('input', e => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('#historyList > div').forEach(div => {
            div.style.display = div.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
    });

    // Invoice
    function getNextInvoice() {
        const today = new Date().toISOString().slice(2,10).replace(/-/g,'');
        const key = 'billbook_counter_' + today;
        let num = (parseInt(localStorage.getItem(key) || '0')) + 1;
        localStorage.setItem(key, num);
        document.getElementById('invoiceNo').textContent = today + '-' + String(num).padStart(3,'0');
    }
    getNextInvoice();
    document.getElementById('billDate').valueAsDate = new Date();

    // Sync text
    function syncText() {
        document.getElementById('customerPrint').textContent = document.getElementById('customer').value || '';
        document.getElementById('descriptionPrint').textContent = document.getElementById('description').value || '';
    }
    ['customer','description'].forEach(id => document.getElementById(id).addEventListener('input', syncText));
    syncText();

    // Billing
    function updateBilling() {
        const lines = document.getElementById('description').value.split('\n').filter(l => l.trim());
        const table = document.getElementById('itemsTable');
        table.innerHTML = '';
        let subtotal = 0;
        lines.forEach(line => {
            const match = line.match(/[$₹£€]?\s*(\d+(?:\.\d{1,2})?)\b/i);
            if (match) {
                const amount = parseFloat(match[1]);
                subtotal += amount;
                table.innerHTML += `<tr><td colspan="2" class="py-0.5">${line.trim()}</td><td class="text-right font-medium">$${amount.toFixed(2)}</td></tr>`;
            }
        });
        const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
        document.getElementById('taxPercent').textContent = taxRate.toFixed(1);
        const tax = subtotal * (taxRate / 100);
        const total = subtotal + tax;
        document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
        document.getElementById('taxAmount').textContent = '$' + tax.toFixed(2);
        document.getElementById('totalDue').textContent = '$' + total.toFixed(2);
    }
    document.getElementById('description').addEventListener('input', updateBilling);
    document.getElementById('taxRate').addEventListener('input', updateBilling);
    document.getElementById('modeToggle').addEventListener('change', e => {
        document.getElementById('billingSection').style.display = e.target.checked ? 'block' : 'none';
        if (e.target.checked) updateBilling();
    });
    document.getElementById('modeToggle').dispatchEvent(new Event('change'));

    // Signature
    const modal = document.getElementById('signatureModal');
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    const preview = document.getElementById('signaturePreview');
    let drawing = false;
    function resizeCanvas() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();
    document.getElementById('addSigBtn').onclick = () => { modal.classList.remove('hidden'); clearModalSignature(); resizeCanvas(); };
    document.getElementById('clearSigBtn').onclick = () => { preview.src = ''; preview.style.display = 'none'; };
    document.getElementById('clearModalBtn').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);
    document.getElementById('cancelModalBtn').onclick = () => modal.classList.add('hidden');
    document.getElementById('doneModalBtn').onclick = () => { preview.src = canvas.toDataURL(); preview.style.display = 'block'; modal.classList.add('hidden'); };
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        return {x,y};
    }
    canvas.addEventListener('mousedown', e => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('touchstart', e => { e.preventDefault(); drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('mousemove', e => { if (drawing) { const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.strokeStyle = '#000'; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.stroke(); }});
    canvas.addEventListener('touchmove', e => { e.preventDefault(); if (drawing) { const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.strokeStyle = '#000'; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.stroke(); }});
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('touchend', () => drawing = false);

    // Save bill
    function saveCurrentBill() {
        syncText();
        const bill = {
            invoiceNo: document.getElementById('invoiceNo').textContent,
            date: document.getElementById('billDate').value,
            customer: document.getElementById('customer').value,
            description: document.getElementById('description').value,
            total: document.getElementById('totalDue').textContent,
            signature: document.getElementById('signaturePreview').src || '',
            html: document.getElementById('bill').innerHTML
        };
        addToHistory(bill);
    }

    // Buttons
    document.getElementById('printBtn').onclick = () => { syncText(); saveCurrentBill(); setTimeout(() => window.print(), 200); };
    document.getElementById('pdfBtn').onclick = () => { syncText(); saveCurrentBill(); setTimeout(() => { const type = document.getElementById('modeToggle').checked ? 'Bill' : 'NSP'; const no = document.getElementById('invoiceNo').textContent; html2pdf().set({margin:8, filename:`${type}_${no}.pdf`, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4'}}).from(document.getElementById('bill')).save(); }, 300); };
    document.getElementById('newBtn').onclick = () => { if (confirm('Start a new bill?')) { document.getElementById('customer').value = ''; document.getElementById('description').value = ''; document.getElementById('signaturePreview').src = ''; document.getElementById('signaturePreview').style.display = 'none'; syncText(); updateBilling(); getNextInvoice(); } };

    // Init
    updateHistoryCount();
});
</script>
</body>
</html>
