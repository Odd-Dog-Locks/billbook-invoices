<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Locksmith Bill Book</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Bill Book">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%1e40af'/><text y='60' font-size='50' text-anchor='middle' x='50' fill='white'>Bill</text></svg>">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:;">
<script src="https://cdn.tailwindcss.com" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
<style>
    @media print {
        @page { margin: 8mm; size: A4 portrait; }
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background: white; }
        #controls, #modeToggleContainer, #signatureModal, #historyView, #tabBill, #tabHistory, .no-print { display: none !important; }
        #billView, #bill { display: block !important; box-shadow: none !important; border-radius: 0 !important; width: 210mm !important; min-height: 297mm !important; margin: 0 !important; }
        .preserve { white-space: pre-line !important; display: block !important; border: 1px solid #d1d5db !important; border-radius: 0.375rem !important; padding: 0.5rem !important; font-size: 0.875rem !important; margin-top: 0.25rem !important; }
        textarea { display: none !important; }
        h1 { font-size: 22pt !important; }
    }
    .preserve { white-space: pre-line; display: none; }
    #signatureCanvas { touch-action: none; }
</style>
</head>
<body class="bg-gray-100 min-h-screen">

<div class="pb-24"></div>

<div id="app" class="max-w-4xl mx-auto p-4">
    <!-- All your existing HTML exactly the same until the signature section -->
    <!-- ... (header, tabs, controls, bill content) ... -->

    <div class="border-t-2 pt-4">
        <strong>Customer Signature:</strong>
        <div class="mt-2 border-2 border-dashed border-gray-500 rounded-lg bg-gray-50" style="height:180px; position:relative;">
            <img id="signaturePreview" src="" class="max-w-full max-h-full object-contain absolute inset-0 m-auto" style="display:none;">
        </div>
        <div class="mt-3 flex gap-3 no-print">
            <button id="addSigBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded">Add Signature</button>
            <button id="clearSigBtn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded">Clear</button>
        </div>
    </div>

    <!-- ... rest of bill ... -->
</div>

<!-- Signature Modal (unchanged) -->
<div id="signatureModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 p-4 no-print">
    <div class="bg-white rounded-2xl shadow-3xl w-full max-w-2xl p-6">
        <h3 class="text-2xl font-bold text-center mb-4">Sign Here</h3>
        <canvas id="signatureCanvas" class="border-4 border-gray-800 rounded-xl bg-white w-full" height="400"></canvas>
        <div class="mt-6 flex justify-center gap-4">
            <button id="clearModalBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded">Clear</button>
            <button id="cancelModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded">Cancel</button>
            <button id="doneModalBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded">Done</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... (all your existing working code: history, billing, invoice number, etc.) ...

    // Signature â€” THE iOS-FIXED VERSION
    const modal = document.getElementById('signatureModal');
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    const preview = document.getElementById('signaturePreview');
    let drawing = false;

    function resizeCanvas() {
        // Preserve drawing when resizing
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.putImageData(imageData, 0, 0);
    }
    window.addEventListener('resize', resizeCanvas);

    document.getElementById('addSigBtn').onclick = () => {
        modal.classList.remove('hidden');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        resizeCanvas();
    };

    document.getElementById('clearSigBtn').onclick = () => {
        preview.src = '';
        preview.style.display = 'none';
    };

    document.getElementById('clearModalBtn').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);
    document.getElementById('cancelModalBtn').onclick = () => modal.classList.add('hidden');

    // THIS IS THE MAGIC LINE THAT FIXES iOS SAFARI FOREVER
    document.getElementById('doneModalBtn').onclick = () => {
        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            preview.src = url;
            preview.style.display = 'block';
            // Clean up old blob URLs to prevent memory leak
            if (preview.dataset.blobUrl) URL.revokeObjectURL(preview.dataset.blobUrl);
            preview.dataset.blobUrl = url;
            modal.classList.add('hidden');
        }, 'image/png');
    };

    // Drawing code (unchanged)
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches?.[0]?.clientX || e.clientX) - rect.left;
        const y = (e.touches?.[0]?.clientY || e.clientY) - rect.top;
        return {x, y};
    }
    canvas.addEventListener('mousedown', e => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('touchstart', e => { e.preventDefault(); drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('mousemove', e => { if(drawing){ const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.strokeStyle='#000'; ctx.lineWidth=4; ctx.lineCap='round'; ctx.stroke(); }});
    canvas.addEventListener('touchmove', e => { e.preventDefault(); if(drawing){ const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.strokeStyle='#000'; ctx.lineWidth=4; ctx.lineCap='round'; ctx.stroke(); }});
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('touchend', () => drawing = false);

    // ... rest of your buttons (Print, PDF, New) stay exactly the same ...
});
</script>
</body>
</html>
